<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VLESS Proxy Configuration</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://cdn.jsdelivr.net/npm/firacode@6.2.0/distr/fira_code.css">
  <link
    href="https://p.typekit.net/p.css?s=1&k=tsd8lrs&ht=tk&f=10954.13453.13458.13460.13461.13464.13465.13470.18498.22487.25676.25679&a=691756&app=typekit&e=css">
  <link
    href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300..700&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Roboto+Mono:wght@100..700&display=swap"
    rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    @font-face {
      font-family: "Aldine 401 BT Web";
      src:
        url("https://pub-7a3b428c76aa411181a0f4dd7fa9064b.r2.dev/Aldine401_Mersedeh.woff2") format("woff2"),
        url("https://pub-b3ab4c8172fb44e29854df3435aa223d.r2.dev/Aldine401_Mersedeh.ttf") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }

    @font-face {
      font-family: "Styrene B LC";
      src: url("https://pub-7a3b428c76aa411181a0f4dd7fa9064b.r2.dev/StyreneBLC-Regular.woff2") format("woff2");
      font-weight: 500; 
      font-style: normal;
      font-display: swap;
    }

    :root {
      --background-primary: #2a2421;
      --background-secondary: #35302c;
      --background-tertiary: #413b35;
      --border-color: #5a4f45;
      --border-color-hover: #766a5f;
      --text-primary: #e5dfd6;
      --text-secondary: #b3a89d;
      --text-accent: #ffffff;
      --accent-primary: #be9b7b;
      --accent-secondary: #d4b595;
      --accent-tertiary: #8d6e5c;
      --accent-primary-darker: #8a6f56;
      --button-text-primary: #2a2421;
      --button-text-secondary: var(--text-primary);
      --shadow-color: rgba(0, 0, 0, 0.35);
      --shadow-color-accent: rgba(190, 155, 123, 0.4);
      --border-radius: 8px;
      --transition-speed: 0.2s;
      --transition-speed-fast: 0.1s;
      --transition-speed-medium: 0.3s;
      --transition-speed-long: 0.6s;
      --status-success: #70b570;
      --status-error: #e05d44;
      --status-warning: #e0bc44; 
      --status-info: #4f90c4;

      --serif: 'Aldine 401 BT Web', 'Times New Roman', Times, Georgia, ui-serif, serif;
      --aldine: "Aldine 401 BT Web", serif;
      --sans-serif: "Styrene B LC", "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial,
        "Segoe UI Symbol", "Noto Color Emoji", sans-serif;
      --mono-serif: "Fira Code", "Roboto Mono", Cantarell, Courier Prime, SFMono-Regular, monospace;
    }

    body {
      font-family: var(--sans-serif);
      font-size: 16px;
      font-weight: 400;
      font-style: normal;
      background-color: var(--background-primary);
      color: var(--text-primary);
      padding: 3rem;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      max-width: 800px;
      margin: 20px auto;
      padding: 0 12px;
      border-radius: var(--border-radius);
      box-shadow:
        0 6px 15px rgba(0, 0, 0, 0.2),
        0 0 25px 8px var(--shadow-color-accent);
      transition: box-shadow var(--transition-speed-medium) ease;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
      padding-top: 30px;
    }

    .header h1 {
      font-family: var(--serif);
      font-weight: 400;
      font-size: 2rem;
      color: var(--text-accent);
      margin-top: 0px;
      margin-bottom: 2px;
    }

    .header p {
      color: var(--text-secondary);
      font-size: 12px;
      font-weight: 400;
    }

    .config-card {
      background: var(--background-secondary);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 24px;
      border: 1px solid var(--border-color);
    }

    .config-title {
      font-family: var(--aldine);
      font-size: 22px;
      font-weight: 400;
      color: var(--accent-secondary);
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .config-title .refresh-btn {
      position: relative;
      overflow: hidden;
      font-family: var(--aldine);
      font-size: 12px;
      padding: 6px 12px;
      border-radius: 4px;
      color: var(--accent-secondary);
      background-color: var(--background-tertiary);
      border: 1px solid var(--border-color);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all var(--transition-speed) ease;
    }
    
    .config-title .refresh-btn:hover {
      background-color: #4d453e;
      color: var(--accent-primary);
      border-color: var(--border-color-hover);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px var(--shadow-color);
    }
        
    .refresh-icon {
      width: 12px;
      height: 12px;
      stroke: currentColor;
    }

    .config-content {
      position: relative;
      background: var(--background-tertiary);
      border-radius: var(--border-radius);
      padding: 16px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }

    .config-content pre {
      overflow-x: auto;
      font-family: var(--mono-serif);
      font-size: 12px;
      color: var(--text-primary);
      margin: 0;
      white-space: pre-wrap;
      word-break: break-all;
      padding-right: 4em;
    }

    .button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: var(--border-radius);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid var(--border-color);
      background-color: var(--background-tertiary);
      color: var(--button-text-secondary);
      transition: all var(--transition-speed) ease;
    }

    .copy-buttons {
      position: absolute;
      top: 10px;
      right: 10px;
      font-family: var(--aldine);
    }

    .client-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .client-btn {
      width: 100%;
      background-color: var(--accent-primary);
      color: var(--background-tertiary);
      border-color: var(--accent-primary-darker);
    }
    .client-btn:hover {
      background-color: var(--accent-secondary);
      color: var(--button-text-primary);
      box-shadow: 0 5px 15px rgba(190, 155, 123, 0.5);
      border-color: var(--accent-secondary);
    }
    .client-icon {
      width: 18px; height: 18px; border-radius: 6px;
      background-color: var(--background-secondary);
      display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    .client-icon svg { width: 14px; height: 14px; fill: var(--accent-secondary); }

    .button.copied { background-color: var(--accent-secondary) !important; color: var(--background-tertiary) !important; }
    .button.error { background-color: #c74a3b !important; color: var(--text-accent) !important; }

    .footer { text-align: center; margin-top: 20px; padding-bottom: 40px; color: var(--text-secondary); font-size: 12px; }
    .footer p { margin-bottom: 0px; }

    .ip-info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(230px, 1fr)); gap: 24px; }
    .ip-info-section { background-color: var(--background-tertiary); border-radius: var(--border-radius); padding: 16px; border: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 20px; }
    .ip-info-header { display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
    .ip-info-header svg { width: 20px; height: 20px; stroke: var(--accent-secondary); }
    .ip-info-header h3 { font-family: var(--aldine); font-size: 18px; color: var(--accent-secondary); margin: 0; }
    .ip-info-content { display: flex; flex-direction: column; gap: 10px; }
    .ip-info-item { display: flex; flex-direction: column; gap: 2px; }
    .ip-info-item .label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
    .ip-info-item .value { font-size: 14px; color: var(--text-primary); word-break: break-all; line-height: 1.4; }

    .badge { display: inline-flex; align-items: center; justify-content: center; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
    .badge-yes { background-color: rgba(112, 181, 112, 0.15); color: var(--status-success); border: 1px solid rgba(112, 181, 112, 0.3); }
    .badge-no { background-color: rgba(224, 93, 68, 0.15); color: var(--status-error); border: 1px solid rgba(224, 93, 68, 0.3); }
    .badge-neutral { background-color: rgba(79, 144, 196, 0.15); color: var(--status-info); border: 1px solid rgba(79, 144, 196, 0.3); }
    .badge-warning { background-color: rgba(224, 188, 68, 0.15); color: var(--status-warning); border: 1px solid rgba(224, 188, 68, 0.3); }

    .skeleton { display: block; background: linear-gradient(90deg, var(--background-tertiary) 25%, var(--background-secondary) 50%, var(--background-tertiary) 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 4px; height: 16px; }
    @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    .country-flag { display: inline-block; width: 18px; height: auto; max-height: 14px; margin-right: 6px; vertical-align: middle; border-radius: 2px; }

    /* Responsive styles from previous version - retained for brevity */
    @media (max-width: 768px) { body { padding: 20px; } .container { padding: 0 14px; } .header h1 { font-size: 24px; } }
    @media (max-width: 480px) { body { padding: 16px; } .container { padding: 0 12px; } .header h1 { font-size: 20px; } }
    @media (max-width: 359px) { body { padding: 12px; font-size: 14px; } .container { padding: 8px; } .header h1 { font-size: 16px; } }
    @media (min-width: 360px) { .container { max-width: 95%; } } @media (min-width: 480px) { .container { max-width: 90%; } } @media (min-width: 640px) { .container { max-width: 600px; } } @media (min-width: 768px) { .container { max-width: 720px; } } @media (min-width: 1024px) { .container { max-width: 800px; } }

  </style>
</head>
<body data-proxy-ip="{{PROXY_IP}}">
  <div class="container">
    <div class="header">
      <h1>VLESS Proxy Configuration</h1>
      <p>Copy the configuration or import directly into your client</p>
    </div>

    <div class="config-card">
      <div class="config-title">
        <span>Network Information</span>
        <button id="refresh-ip-info" class="refresh-btn" aria-label="Refresh IP information">
          <svg class="refresh-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2" />
          </svg>
          Refresh
        </button>
      </div>

      <div class="ip-info-grid">
        <div class="ip-info-section">
          <div class="ip-info-header">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M15.5 2H8.6c-.4 0-.8.2-1.1.5-.3.3-.5.7-.5 1.1v16.8c0 .4.2.8.5 1.1.3.3.7.5 1.1.5h6.9c.4 0 .8-.2 1.1-.5.3-.3.5-.7.5-1.1V3.6c0-.4-.2-.8-.5-1.1-.3-.3-.7-.5-1.1-.5z"/>
              <circle cx="12" cy="18" r="1"/>
            </svg>
            <h3>Proxy Server</h3>
          </div>
          <div class="ip-info-content">
            <div class="ip-info-item"> 
              <span class="label">Proxy Host</span>
              <span class="value" id="proxy-host"><span class="skeleton" style="width: 150px;"></span></span>
            </div>
            <div class="ip-info-item">
              <span class="label">IP Address</span>
              <span class="value" id="proxy-ip"><span class="skeleton" style="width: 120px;"></span></span>
            </div>
            <div class="ip-info-item">
              <span class="label">Location</span>
              <span class="value" id="proxy-location"><span class="skeleton" style="width: 100px;"></span></span>
            </div>
            <div class="ip-info-item">
              <span class="label">ISP Provider</span>
              <span class="value" id="proxy-isp"><span class="skeleton" style="width: 140px;"></span></span>
            </div>
          </div>
        </div>

        <div class="ip-info-section">
          <div class="ip-info-header">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 16V7a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v9m16 0H4m16 0 1.28 2.55a1 1 0 0 1-.9 1.45H3.62a1 1 0 0 1-.9-1.45L4 16"/>
            </svg>
            <h3>Your Connection</h3>
          </div>
          <div class="ip-info-content">
            <div class="ip-info-item">
              <span class="label">Your IP</span>
              <span class="value" id="client-ip"><span class="skeleton" style="width: 110px;"></span></span>
            </div>
            <div class="ip-info-item">
              <span class="label">Location</span>
              <span class="value" id="client-location"><span class="skeleton" style="width: 90px;"></span></span>
            </div>
            <div class="ip-info-item">
              <span class="label">ISP Provider</span>
              <span class="value" id="client-isp"><span class="skeleton" style="width: 130px;"></span></span>
            </div>
            <div class="ip-info-item">
              <span class="label">Risk Score</span> 
              <span class="value" id="client-proxy"> 
                <span class="skeleton" style="width: 100px;"></span> 
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="config-card">
      <div class="config-title">Xray Core Clients</div>
      <div class="config-content">
        <button class="button copy-buttons" onclick="copyToClipboard(this, '{{DREAM_CONFIG}}')">Copy</button>
        <pre id="xray-config">{{DREAM_CONFIG}}</pre>
      </div>
      <div class="client-buttons">
        <a href="hiddify://install-config?url={{FREEDOM_CONFIG_ENCODED}}" class="button client-btn">
          <span class="client-icon"><svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" /></svg></span>
          <span class="button-text">Import to Hiddify</span>
        </a>
        <a href="v2rayng://install-config?url={{DREAM_CONFIG_ENCODED}}" class="button client-btn">
          <span class="client-icon"><svg viewBox="0 0 24 24"><path d="M12 2L4 5v6c0 5.5 3.5 10.7 8 12.3 4.5-1.6 8-6.8 8-12.3V5l-8-3z" /></svg></span>
          <span class="button-text">Import to V2rayNG</span>
        </a>
      </div>
    </div>

    <div class="config-card">
      <div class="config-title">Sing-Box Core Clients</div>
      <div class="config-content">
        <button class="button copy-buttons" onclick="copyToClipboard(this, '{{FREEDOM_CONFIG}}')">Copy</button>
        <pre id="singbox-config">{{FREEDOM_CONFIG}}</pre>
      </div>
      <div class="client-buttons">
        <a href="{{CLASH_META_URL}}" class="button client-btn">
          <span class="client-icon"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z" /></svg></span>
          <span class="button-text">Import to Clash Meta</span>
        </a>
        <a href="{{NEKOBOX_URL}}" class="button client-btn">
          <span class="client-icon"><svg viewBox="0 0 24 24"><path d="M20,8h-3V6c0-1.1-0.9-2-2-2H9C7.9,4,7,4.9,7,6v2H4C2.9,8,2,8.9,2,10v9c0,1.1,0.9,2,2,2h16c1.1,0,2-0.9,2-2v-9 C22,8.9,21.1,8,20,8z M9,6h6v2H9V6z M20,19H4v-2h16V19z M20,15H4v-5h3v1c0,0.55,0.45,1,1,1h1.5c0.28,0,0.5-0.22,0.5-0.5v-0.5h4v0.5 c0,0.28,0.22,0.5,0.5,0.5H16c0.55,0,1-0.45,1-1v-1h3V15z" /><circle cx="8.5" cy="13.5" r="1" /><circle cx="15.5" cy="13.5" r="1" /><path d="M12,15.5c-0.55,0-1-0.45-1-1h2C13,15.05,12.55,15.5,12,15.5z" /></svg></span>
          <span class="button-text">Import to NekoBox</span>
        </a>
      </div>
    </div>

    <div class="footer">
      <p>© <span id="current-year">{{YEAR}}</span> REvil - All Rights Reserved</p>
      <p>Secure. Private. Fast.</p>
    </div>
  </div>

  <script>
    function copyToClipboard(button, text) {
      const originalText = button.textContent;
      // ... (rest of copyToClipboard function remains the same) ...
      navigator.clipboard.writeText(text).then(() => {
        button.textContent = "Copied!";
        button.classList.add("copied");
        setTimeout(() => {
          button.textContent = originalText;
          button.classList.remove("copied");
          button.disabled = false;
        }, 1200);
      }).catch(err => {
        console.error("Failed to copy text: ", err);
        button.textContent = "Error";
        button.classList.add("error");
        setTimeout(() => {
          button.textContent = originalText;
          button.classList.remove("error");
          button.disabled = false;
        }, 1500);
      });
    }

    // Scamalytics API Configuration - !IMPORTANT: Replace with your actual credentials
    const scamalyticsUsername = "<YOUR_SCAMALYTICS_USERNAME>"; // e.g., "dianaclk01"
    const scamalyticsApiKey = "<YOUR_SCAMALYTICS_API_KEY>";   // e.g., "c57eb62bbd..."
    const scamalyticsApiBaseUrl = "https://api11.scamalytics.com/v3/"; // Or api12 for EU

    /**
     * Fetches the client's public IP address.
     * @returns {Promise<string|null>} IP address string or null on error.
     */
    async function fetchClientPublicIP() {
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        return data.ip;
      } catch (error) {
        console.error('Error fetching client IP:', error);
        return null;
      }
    }
    
    /**
     * Fetches client IP information from Scamalytics.
     * @param {string} clientIp - The client's IP address.
     * @returns {Promise<object|null>} IP data or null on error.
     */
    async function fetchScamalyticsClientInfo(clientIp) {
      if (!clientIp) return null;
      // IMPORTANT: Replace placeholders with your actual username and API key
      if (scamalyticsUsername === "<YOUR_SCAMALYTICS_USERNAME>" || scamalyticsApiKey === "<YOUR_SCAMALYTICS_API_KEY>") {
          console.error("Scamalytics username or API key not configured.");
          alert("Scamalytics API is not configured. Please set username and API key in the script."); // User-facing alert
          return null;
      }
      try {
        const url = `${scamalyticsApiBaseUrl}${scamalyticsUsername}/?key=${scamalyticsApiKey}&ip=${clientIp}`;
        const response = await fetch(url);
        if (!response.ok) {
          // Scamalytics might return errors in JSON even with non-200 codes [cite: 109, 110, 111]
          let errorDetail = `HTTP error! status: ${response.status}`;
          try {
            const errorData = await response.json();
            if (errorData && errorData.scamalytics && errorData.scamalytics.status === 'error' && errorData.scamalytics.error) {
                errorDetail = errorData.scamalytics.error;
            } else if (errorData && errorData.error_message) { // General error structure
                errorDetail = errorData.error_message;
            }
          } catch (e) { /* Ignore if error response is not JSON */ }
          throw new Error(errorDetail);
        }
        const data = await response.json();
        if (data.scamalytics && data.scamalytics.status === 'error') {
            throw new Error(data.scamalytics.error || 'Scamalytics API error');
        }
        return data;
      } catch (error) {
        console.error('Scamalytics API Error:', error);
        return null;
      }
    }

    /**
     * Updates the display for client IP information using data from Scamalytics.
     * @param {object|null} data - IP data from Scamalytics.
     */
    function updateScamalyticsClientDisplay(data) {
      const prefix = 'client';
      if (!data || !data.scamalytics || data.scamalytics.status !== 'ok') {
        showError(prefix, (data && data.scamalytics && data.scamalytics.error) || 'Could not load data from Scamalytics');
        return;
      }

      const sa = data.scamalytics;
      const dbip = data.external_datasources?.dbip;

      const elements = {
        ip: document.getElementById(`${prefix}-ip`),
        location: document.getElementById(`${prefix}-location`),
        isp: document.getElementById(`${prefix}-isp`),
        proxy: document.getElementById(`${prefix}-proxy`) // For Risk Score
      };

      if (elements.ip) elements.ip.textContent = sa.ip || "N/A"; // [cite: 10, 22]

      if (elements.location) {
        const city = dbip?.ip_city || ''; // [cite: 15, 39]
        const countryName = dbip?.ip_country_name || ''; // [cite: 15, 41]
        const countryCode = dbip?.ip_country_code ? dbip.ip_country_code.toLowerCase() : ''; // [cite: 15, 38]
        let locationString = 'N/A';
        let flagElementHtml = '';

        if (countryCode) {
          flagElementHtml = `<img src="https://flagcdn.com/w20/${countryCode}.png" srcset="https://flagcdn.com/w40/${countryCode}.png 2x" alt="${dbip.ip_country_code}" class="country-flag"> `;
        }
        
        let textPart = '';
        if (city && countryName) textPart = `${city}, ${countryName}`;
        else if (countryName) textPart = countryName;
        else if (city) textPart = city;

        if (flagElementHtml || textPart) locationString = `${flagElementHtml}${textPart}`.trim();
        elements.location.innerHTML = locationString || "N/A";
      }

      if (elements.isp) {
          elements.isp.textContent = sa.scamalytics_isp || dbip?.isp_name || "N/A"; // [cite: 5, 15, 41]
      }
      
      if (elements.proxy) { 
        const score = sa.scamalytics_score; // [cite: 10, 23]
        const risk = sa.scamalytics_risk;   // [cite: 10, 25]
        let riskText = "Unknown";
        let badgeClass = "badge-neutral";

        if (risk !== undefined && score !== undefined) {
            // Use score to make text, use risk string for badge mapping
            riskText = `${score} - ${risk.charAt(0).toUpperCase() + risk.slice(1)}`;
            switch (risk.toLowerCase()) { // [cite: 25, 99]
                case "low": badgeClass = "badge-yes"; break;
                case "medium": badgeClass = "badge-warning"; break;
                case "high": badgeClass = "badge-no"; break;
                case "very high": badgeClass = "badge-no"; break; // Or a darker red if defined
                default: riskText = `Score ${score} - Unknown Risk`; break;
            }
        } else if (score !== undefined) {
            riskText = `Score ${score} - N/A`; // Has score but no risk string
        } else if (risk) {
            riskText = risk.charAt(0).toUpperCase() + risk.slice(1); // Has risk string but no score
             switch (risk.toLowerCase()) {
                case "low": badgeClass = "badge-yes"; break;
                case "medium": badgeClass = "badge-warning"; break;
                case "high": case "very high": badgeClass = "badge-no"; break;
            }
        }
        elements.proxy.innerHTML = `<span class="badge ${badgeClass}">${riskText}</span>`;
      }
    }

    function updateIpApiIoDisplay(geo, prefix, originalHost) {
      // ... (This function remains the same as in the previous version for Proxy Server info)
      const hostElement = document.getElementById(`${prefix}-host`);
      if (hostElement) hostElement.textContent = originalHost || "N/A";

      const ipElement = document.getElementById(`${prefix}-ip`);
      const locationElement = document.getElementById(`${prefix}-location`);
      const ispElement = document.getElementById(`${prefix}-isp`);

      if (!geo) {
        if (ipElement) ipElement.textContent = "N/A";
        if (locationElement) locationElement.innerHTML = "N/A";
        if (ispElement) ispElement.textContent = "N/A";
        return;
      }

      if (ipElement) ipElement.textContent = geo.ip || "N/A";
      
      if (locationElement) {
        const city = geo.city || '';
        const countryName = geo.country_name || '';
        const countryCode = geo.country_code ? geo.country_code.toLowerCase() : '';
        let flagElementHtml = '';

        if (countryCode) {
            flagElementHtml = `<img src="https://flagcdn.com/w20/${countryCode}.png" srcset="https://flagcdn.com/w40/${countryCode}.png 2x" alt="${geo.country_code || 'flag'}" class="country-flag"> `;
        } else if (geo.country_flag) { 
            flagElementHtml = `${geo.country_flag} `;
        }
        
        let textPart = '';
        if (city && countryName) textPart = `${city}, ${countryName}`;
        else if (countryName) textPart = countryName;
        else if (city) textPart = city;

        let locationText = 'N/A';
        if (flagElementHtml.trim() || textPart.trim()) {
            locationText = `${flagElementHtml}${textPart}`.trim();
        }
        locationElement.innerHTML = locationText || "N/A";
      }
      if (ispElement) {
        ispElement.textContent = geo.isp || geo.org || geo.as_name || geo.as || 'N/A';
      }
    }

    async function fetchIpApiIoInfo(ip) {
      // ... (This function remains the same for Proxy Server info)
      try {
        const response = await fetch(`https://ip-api.io/json/${ip}`);
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
        }
        return await response.json();
      } catch (error) {
        console.error('IP API Error (ip-api.io):', error);
        return null;
      }
    }

    function showError(prefix, message = "Could not load data", originalHostForProxy = null) {
      // ... (This function remains largely the same, client part targets correct IDs)
      const errorMessage = "N/A";
      if (prefix === 'proxy') {
        document.getElementById('proxy-host').textContent = originalHostForProxy || errorMessage;
        document.getElementById('proxy-ip').textContent = errorMessage;
        document.getElementById('proxy-location').innerHTML = errorMessage;
        document.getElementById('proxy-isp').textContent = errorMessage;
      } else if (prefix === 'client') {
        document.getElementById('client-ip').textContent = errorMessage;
        document.getElementById('client-location').innerHTML = errorMessage;
        document.getElementById('client-isp').textContent = errorMessage;
        document.getElementById('client-proxy').innerHTML = `<span class="badge badge-neutral">N/A</span>`; // For Risk Score
      }
      console.warn(`${prefix} data loading failed: ${message}`);
    }

    async function loadNetworkInfo() {
      try {
        // --- Load Proxy Server Info (ip-api.io) ---
        const proxyDomainOrIp = document.body.getAttribute('data-proxy-ip');
        let resolvedProxyIp = proxyDomainOrIp; 
        const proxyHostVal = (proxyDomainOrIp && proxyDomainOrIp !== "N/A" && proxyDomainOrIp.toLowerCase() !== "null") ? proxyDomainOrIp : "N/A";
        
        const proxyHostEl = document.getElementById('proxy-host');
        if(proxyHostEl) proxyHostEl.textContent = proxyHostVal;

        if (proxyHostVal !== "N/A") {
          if (!/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(proxyDomainOrIp)) { 
            try {
              const dnsRes = await fetch(`https://dns.google/resolve?name=${encodeURIComponent(proxyDomainOrIp)}&type=A`);
              if (dnsRes.ok) {
                  const dnsData = await dnsRes.json();
                  if (dnsData.Answer && dnsData.Answer.length > 0) {
                    const ipAnswer = dnsData.Answer.find(a => a.type === 1); 
                    if (ipAnswer) resolvedProxyIp = ipAnswer.data;
                  }
              }
            } catch (e) { console.error('DNS resolution for proxy failed:', e); }
          }
          const proxyGeoData = await fetchIpApiIoInfo(resolvedProxyIp); 
          if (proxyGeoData && (proxyGeoData.ip || proxyGeoData.country_code)) { 
            updateIpApiIoDisplay(proxyGeoData, 'proxy', proxyHostVal); 
          } else {
            showError('proxy', `Could not load proxy geo data for ${resolvedProxyIp}.`, proxyHostVal);
          }
        } else {
          showError('proxy', 'Proxy Host not available', proxyHostVal);
        }

        // --- Load Client Info (Scamalytics) ---
        console.log('Fetching client public IP...');
        const clientIp = await fetchClientPublicIP();
        if (clientIp) {
          document.getElementById('client-ip').textContent = clientIp; // Show IP as soon as it's fetched
          console.log('Loading client info from Scamalytics for IP:', clientIp);
          const scamalyticsData = await fetchScamalyticsClientInfo(clientIp); 
          if (scamalyticsData) {
            updateScamalyticsClientDisplay(scamalyticsData); 
          } else {
            // showError might have been called inside fetchScamalyticsClientInfo or updateScamalyticsClientDisplay
            // if not, call it here explicitly for the client section.
            // Ensure client-ip is N/A if scamalyticsData is null but IP was fetched.
            if(!document.getElementById('client-proxy').textContent.includes("badge")){ // if not already set by more specific error
                showError('client', 'Failed to get details from Scamalytics.');
            }
             // If IP was fetched but Scamalytics failed, IP might still be shown.
             // Set client-ip to N/A as well if full data retrieval failed.
            if (!scamalyticsData) document.getElementById('client-ip').textContent = "N/A";
          }
        } else {
          showError('client', 'Could not determine your IP address.');
        }

      } catch (error) {
        console.error('Overall network info loading failed:', error);
        showError('proxy', `Error: ${error.message}`, document.body.getAttribute('data-proxy-ip') || "N/A");
        showError('client', `Error: ${error.message}`);
      }
    }

    document.getElementById('refresh-ip-info')?.addEventListener('click', function() {
      // ... (Refresh button logic remains the same)
      const button = this;
      const icon = button.querySelector('.refresh-icon');
      button.disabled = true;
      if (icon) icon.style.animation = 'spin 1s linear infinite';
      
      const resetToSkeleton = (prefix) => {
        const elementsToReset = ['ip', 'location', 'isp'];
        if (prefix === 'proxy') elementsToReset.push('host'); 
        if (prefix === 'client') elementsToReset.push('proxy'); // client-proxy is for Risk Score

        elementsToReset.forEach(elemKey => {
          const element = document.getElementById(`${prefix}-${elemKey}`);
          if (element) {
            let skeletonWidth = "100px"; 
            if (elemKey === 'isp') skeletonWidth = "130px";
            else if (elemKey === 'location') skeletonWidth = "110px";
            else if (elemKey === 'ip') skeletonWidth = "120px";
            else if (elemKey === 'host' && prefix === 'proxy') skeletonWidth = "150px";
            else if (elemKey === 'proxy' && prefix === 'client') skeletonWidth = "100px";
            element.innerHTML = `<span class="skeleton" style="width: ${skeletonWidth};"></span>`;
          }
        });
      };

      resetToSkeleton('proxy');
      resetToSkeleton('client');
      loadNetworkInfo().finally(() => setTimeout(() => {
        button.disabled = false; if (icon) icon.style.animation = '';
      }, 1000));
    });

    const style = document.createElement('style');
    style.textContent = `@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }`;
    document.head.appendChild(style);
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Page loaded, initializing network info...');
      loadNetworkInfo();
    });
</script>
</body>
</html>
